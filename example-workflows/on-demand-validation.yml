name: On-Demand Issue Validation

# This workflow only runs when you add the "validate_issues" label to a PR
# Useful for selective validation or re-validation after addressing feedback

on:
  pull_request:
    types: [labeled]

permissions:
  contents:      read
  pull-requests: write
  issues:        read

jobs:
  validate-issues:
    # Only run if the label is "validate_issues"
    if:      github.event.label.name == 'validate_issues'
    runs-on: ubuntu-latest
    name:    Validate PR implements referenced issues
    steps:
      - name: Validate Issue Implementation
        uses: augmentcode/issue-review-pr@v0
        with:
          augment_session_auth: ${{ secrets.AUGMENT_SESSION_AUTH }}
          github_token:         ${{ secrets.GITHUB_TOKEN }}
          pull_number:          ${{ github.event.pull_request.number }}
          repo_name:            ${{ github.repository }}

      - name: Remove validation label
        if:   always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script:       |
                        await github.rest.issues.removeLabel({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          name: 'validate_issues'
                        });

      - name: Add completion label
        uses: actions/github-script@v7
        with:
          script: |
                  // Add a label to indicate the review was generated
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    labels: ['auto-issue-validation']
                  });
